<!DOCTYPE html>
<html lang="en" data-coreui-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/@coreui/coreui/dist/css/coreui.min.css" rel="stylesheet" integrity="sha384-hazw3X5QZ2q1iOnw6S3SywpZC1h7tIuXVRXTBTvI5a/mNy+BHeenuvDTNgFv12f5" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@coreui/icons/css/all.min.css">
    <title>Cats vs Dogs Voting</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js"></script>
    <style>
        .wallet-not-connected {
            display: none;
        }
    </style>
</head>
<body>
<div class="container" style="max-width: 20em">
    <div class="row my-2">
        <div class="col text-center">
            Polygon network
            <h1>Cats vs Dogs</h1>
        </div>
    </div>
    <div class=" wallet-not-connected">
        <div class="row my-2">
            <div class="col text-center">
                <span id="catVotes" class="h1">0</span>
            </div>
            <div class="col text-center">
                <span id="dogVotes" class="h1">0</span>
            </div>
        </div>
        <div class="row my-2">
            <div class="col text-center">
                <button class="btn btn-primary w-100" id="voteCats">Cats</button>
            </div>
            <div class="col text-center">
                <button class="btn btn-primary w-100" id="voteDogs">Dogs</button>
            </div>
        </div>
        <div class="row my-2">
            <div class="col text-center text-muted">
                Last Voter: <span id="lastVoter">...</span>
            </div>
        </div>
    </div>
    <div class="row my-2 wallet-connected">
        <button class="btn btn-primary w-100" id="connect">Connect Wallet</button>
    </div>
</div>

<script>
    if (typeof window.ethereum !== 'undefined') {
        console.log('MetaMask is installed!');
    } else {
        alert('Please install MetaMask to use this app.');
    }

    const contractAddress = "0x8F8FC628c371B96B8c934A7fb65eEC6a75295e34";
    const contractABI = [
        {
            "inputs": [],
            "stateMutability": "nonpayable",
            "type": "constructor"
        },
        {
            "anonymous": false,
            "inputs": [
                {
                    "indexed": true,
                    "internalType": "uint256",
                    "name": "catVotes",
                    "type": "uint256"
                },
                {
                    "indexed": true,
                    "internalType": "uint256",
                    "name": "dogVotes",
                    "type": "uint256"
                },
                {
                    "indexed": true,
                    "internalType": "address",
                    "name": "lastVoter",
                    "type": "address"
                }
            ],
            "name": "VotesChanged",
            "type": "event"
        },
        {
            "inputs": [],
            "name": "catVotes",
            "outputs": [
                {
                    "internalType": "uint256",
                    "name": "",
                    "type": "uint256"
                }
            ],
            "stateMutability": "view",
            "type": "function"
        },
        {
            "inputs": [],
            "name": "dogVotes",
            "outputs": [
                {
                    "internalType": "uint256",
                    "name": "",
                    "type": "uint256"
                }
            ],
            "stateMutability": "view",
            "type": "function"
        },
        {
            "inputs": [],
            "name": "lastVoter",
            "outputs": [
                {
                    "internalType": "address",
                    "name": "",
                    "type": "address"
                }
            ],
            "stateMutability": "view",
            "type": "function"
        },
        {
            "inputs": [],
            "name": "voteForCat",
            "outputs": [],
            "stateMutability": "nonpayable",
            "type": "function"
        },
        {
            "inputs": [],
            "name": "voteForDog",
            "outputs": [],
            "stateMutability": "nonpayable",
            "type": "function"
        }
    ];

    async function updateUI(contract) {
        if (!window.ethereum) return;

        console.log("updating UI");

        const catVotes = await contract.catVotes();
        console.log("catVotes:", catVotes);

        const dogVotes = await contract.dogVotes();
        console.log("dogVotes:", dogVotes);

        const lastVoter = await contract.lastVoter();
        console.log("lastVoter:", lastVoter);

        document.getElementById('catVotes').innerText = catVotes;
        document.getElementById('dogVotes').innerText = dogVotes;
        document.getElementById('lastVoter').innerText = lastVoter;
    }

    document.getElementById('connect').addEventListener('click', async () => {
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        const signer = provider.getSigner();
        const contract = new ethers.Contract(contractAddress, contractABI, signer);

        for (let el of document.getElementsByClassName('wallet-not-connected')) {
            el.classList.remove('wallet-not-connected');
        }

        for (let el of document.getElementsByClassName('wallet-connected')) {
            el.classList.add('d-none');
        }

        document.getElementById('voteCats').addEventListener('click', async () => {
            const tx = await contract.voteForCat();
            console.log("vote cats tx:", tx);
            await tx.wait();
            await updateUI();
        });

        document.getElementById('voteDogs').addEventListener('click', async () => {
            const tx = await contract.voteForDog();
            console.log("vote dogs tx:", tx);
            await tx.wait();
            await updateUI();
        });

        await provider.send('eth_requestAccounts', []);
        updateUI(contract);
    });
</script>
</body>
</html>
